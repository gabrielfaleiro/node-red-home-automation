[{"id":"36312b41f6fef150","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"6f077b255b7f1bbe","type":"tab","label":"Flow 2","disabled":true,"info":""},{"id":"59147d7eb45f072e","type":"tab","label":"Flow 3","disabled":false,"info":""},{"id":"5c2f7edf9f4429fb","type":"smartthings-config","name":"node-red-home-automation","token":"dd97ae23-b6da-42f8-bd13-58043ebeab2f"},{"id":"c4678117286aa543","type":"mqtt-broker","name":"","broker":"mqttbroker","port":"1883","clientid":"raspi4homeautomation","usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"b57aa3e2484a7237","type":"mqtt-broker","name":"","broker":"mqttbroker-dev","port":"1883","clientid":"raspi4homeautomation","usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"00c81a13c58a1a76","type":"postgreSQLConfig","name":"","host":"postgresql","hostFieldType":"str","port":"5432","portFieldType":"num","database":"home","databaseFieldType":"str","ssl":"false","sslFieldType":"bool","max":"10","maxFieldType":"num","min":"1","minFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"home","userFieldType":"str","password":"raspi","passwordFieldType":"str"},{"id":"6e9403f87fed2103","type":"smartthings-node-onoff","z":"36312b41f6fef150","conf":"5c2f7edf9f4429fb","name":"Lámpara sofá","device":"448d23b5-51a0-4b87-8097-171b589aa657","x":500,"y":80,"wires":[["ed8ef3c0786369d0"]]},{"id":"ed8ef3c0786369d0","type":"debug","z":"36312b41f6fef150","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":730,"y":80,"wires":[]},{"id":"79953445deefe147","type":"inject","z":"36312b41f6fef150","name":"Switch On","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"switch","payload":"{\"value\":1}","payloadType":"json","x":140,"y":80,"wires":[["6e9403f87fed2103"]]},{"id":"f6519485934a5e7c","type":"inject","z":"36312b41f6fef150","name":"Switch Off","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"switch","payload":"{\"value\":0}","payloadType":"json","x":140,"y":140,"wires":[["6e9403f87fed2103"]]},{"id":"8efdb04bb6c80422","type":"comment","z":"36312b41f6fef150","name":"No todos los comandos llegan, necesitamos feedback de control","info":"","x":550,"y":160,"wires":[]},{"id":"1ef8fb1deb2a5631","type":"inject","z":"36312b41f6fef150","name":"Update","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"update","payloadType":"date","x":130,"y":200,"wires":[["6e9403f87fed2103"]]},{"id":"2fc91f69fe8eed12","type":"mqtt in","z":"6f077b255b7f1bbe","name":"","topic":"+/+/global/#","qos":"2","datatype":"buffer","broker":"c4678117286aa543","nl":false,"rap":true,"rh":0,"x":230,"y":140,"wires":[["99238f65f9dde5e7"]]},{"id":"99238f65f9dde5e7","type":"debug","z":"6f077b255b7f1bbe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":450,"y":140,"wires":[]},{"id":"a1fe05fb66649edf","type":"inject","z":"6f077b255b7f1bbe","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":290,"y":220,"wires":[["13d12ed8d566b1b5"]]},{"id":"13d12ed8d566b1b5","type":"mqtt out","z":"6f077b255b7f1bbe","name":"","topic":"+/+/nodes/command/#","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"c4678117286aa543","x":560,"y":220,"wires":[]},{"id":"e36466a2f3a884e2","type":"mqtt in","z":"6f077b255b7f1bbe","name":"","topic":"+/+/node/+/data/#","qos":"2","datatype":"buffer","broker":"c4678117286aa543","nl":false,"rap":true,"rh":0,"x":240,"y":80,"wires":[["99238f65f9dde5e7"]]},{"id":"aa80b40520c54f73","type":"mqtt in","z":"59147d7eb45f072e","name":"","topic":"home_automation/1/node/+/data/temperature","qos":"1","datatype":"utf8","broker":"b57aa3e2484a7237","nl":false,"rap":true,"rh":0,"x":290,"y":80,"wires":[["f4e5f426e4df9444","9639b7ef610965c4"]]},{"id":"68a988fa7438ef37","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"home_automation/1/node/esp8266dev_temp_sensor_1/command/led_control","payload":"1","payloadType":"str","x":170,"y":240,"wires":[["e74a221fe39594ae"]]},{"id":"e74a221fe39594ae","type":"mqtt out","z":"59147d7eb45f072e","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"b57aa3e2484a7237","x":450,"y":240,"wires":[]},{"id":"fd9e07d0fb8f8e23","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"qos","v":"0","vt":"num"},{"p":"retain","v":"false","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"home_automation/1/node/esp8266dev_temp_sensor_1/command/led_control","payload":"0","payloadType":"str","x":170,"y":280,"wires":[["e74a221fe39594ae"]]},{"id":"22e2411870158bb1","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"home_automation/1/node/esp8266dev_temp_sensor_1/command/led_control","payload":"abc","payloadType":"str","x":170,"y":320,"wires":[["e74a221fe39594ae"]]},{"id":"52f46a8304667ffe","type":"postgresql","z":"59147d7eb45f072e","name":"select temp_sensors","query":"SELECT * FROM temp_sensors;","postgreSQLConfig":"00c81a13c58a1a76","split":false,"rowsPerMsg":1,"outputs":1,"x":640,"y":440,"wires":[["f0cf98dfce19052a"]]},{"id":"248dd6a35d59e4b5","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":420,"y":440,"wires":[["52f46a8304667ffe"]]},{"id":"f0cf98dfce19052a","type":"debug","z":"59147d7eb45f072e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":890,"y":440,"wires":[]},{"id":"f4e5f426e4df9444","type":"function","z":"59147d7eb45f072e","name":"insert temp_sensors","func":"\ntime = new Date().toISOString().replace(/T/, ' ').replace(/\\..+/, '');\nsource = msg.topic.split(\"/\")[3];\nvalue = parseInt(msg.payload);\n\n\nmsgOut = {\n    \"payload\": {\n        \"time\": time,\n        \"value\": value,\n        \"source\": source,\n        \"sensor_type\": \"DHT22\",\n        \"units\": \"celsius\",\n        \"scale\": 10,\n        \"db_table\": \"temp_sensors\"\n    }\n}\n\n\nreturn msgOut;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":80,"wires":[["1ab64ca826dd3cf1"]]},{"id":"2f4da83b018c34ef","type":"mqtt in","z":"59147d7eb45f072e","name":"","topic":"home_automation/1/node/+/data/relative_humidity","qos":"1","datatype":"utf8","broker":"b57aa3e2484a7237","nl":false,"rap":true,"rh":0,"x":310,"y":160,"wires":[["99da2a0ce301f025"]]},{"id":"99da2a0ce301f025","type":"function","z":"59147d7eb45f072e","name":"insert humidity_sensors","func":"\ntime = new Date().toISOString().replace(/T/, ' ').replace(/\\..+/, '');\nsource = msg.topic.split(\"/\")[3];\nvalue = parseInt(msg.payload);\n\n\nmsgOut = {\n    \"payload\": {\n        \"time\": time,\n        \"value\": value,\n        \"source\": source,\n        \"sensor_type\": \"DHT22\",\n        \"units\": \"percentage\",\n        \"scale\": 10,\n        \"db_table\": \"humidity_sensors\"\n    }\n}\n\n\nreturn msgOut;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":160,"wires":[["1ab64ca826dd3cf1"]]},{"id":"1ab64ca826dd3cf1","type":"postgresql","z":"59147d7eb45f072e","name":"","query":"INSERT INTO {{{ msg.payload.db_table }}}\n    (time, value, source, units, scale, sensor_type)\n    VALUES\n    ('{{{ msg.payload.time }}}',\n    {{{ msg.payload.value }}},\n    '{{{ msg.payload.source }}}',\n    '{{{ msg.payload.units }}}',\n    {{{ msg.payload.scale }}},\n    '{{{ msg.payload.sensor_type }}}')\n;","postgreSQLConfig":"00c81a13c58a1a76","split":false,"rowsPerMsg":1,"outputs":1,"x":930,"y":120,"wires":[[]]},{"id":"184c5ae8d84e92e0","type":"postgresql","z":"59147d7eb45f072e","name":"select humidity_sensors","query":"SELECT * FROM humidity_sensors;","postgreSQLConfig":"00c81a13c58a1a76","split":false,"rowsPerMsg":1,"outputs":1,"x":650,"y":480,"wires":[["db6ef370a5b3f08b"]]},{"id":"41c3dac4ae7ef487","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":420,"y":480,"wires":[["184c5ae8d84e92e0"]]},{"id":"db6ef370a5b3f08b","type":"debug","z":"59147d7eb45f072e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":890,"y":480,"wires":[]},{"id":"9639b7ef610965c4","type":"debug","z":"59147d7eb45f072e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":40,"wires":[]},{"id":"a2d85e49e8ea315b","type":"comment","z":"59147d7eb45f072e","name":"Prune","info":"","x":190,"y":560,"wires":[]},{"id":"ff8a9655e4330a28","type":"postgresql","z":"59147d7eb45f072e","name":"prune","query":"DELETE FROM {{{ msg.payload.db_table }}} WHERE time < '{{{ msg.payload.time }}}';","postgreSQLConfig":"00c81a13c58a1a76","split":false,"rowsPerMsg":1,"outputs":1,"x":750,"y":660,"wires":[[]]},{"id":"0fa930052e4b76db","type":"inject","z":"59147d7eb45f072e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"21600","crontab":"","once":true,"onceDelay":"10","topic":"","payloadType":"date","x":150,"y":660,"wires":[["d2cf5064ca5667d0"]]},{"id":"d2cf5064ca5667d0","type":"function","z":"59147d7eb45f072e","name":"time","func":"\nprune_hours = 24*7;\n\ntime = new Date(new Date() - prune_hours*60*60*1000); // ms\ntime_str = time.toISOString().replace(/T/, ' ').replace(/\\..+/, '');\n\nmsgOut = {\n    \"payload\": {\n        \"time\": time_str\n    }\n}\n\nreturn msgOut;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":660,"wires":[["174727357801c1c8","ef199a3aba251ffd"]]},{"id":"174727357801c1c8","type":"function","z":"59147d7eb45f072e","name":"temp_sensors","func":"msg.payload.db_table = \"temp_sensors\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":660,"wires":[["ff8a9655e4330a28"]]},{"id":"ef199a3aba251ffd","type":"function","z":"59147d7eb45f072e","name":"humidity_sensors","func":"msg.payload.db_table = \"humidity_sensors\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":700,"wires":[["ff8a9655e4330a28"]]}]